tinymce.PluginManager.add("ptw_textcolor",function(o){function e(e){var r;return o.dom.getParents(o.selection.getStart(),function(o){var t;!r&&(t=o.style["forecolor"==e?"color":"background-color"])&&(r=t),r||(r="forecolor"==e?jQuery(o).css("color"):jQuery(o).css("background-color"))}),r}function r(e,r){o.focus(),o._ptwColorPickerBookmark&&o.selection.moveToBookmark(o._ptwColorPickerBookmark),o.formatter.apply(e,{value:r})}function t(o){if(o){if(o._items&&o._items.length)for(var e=0;e<o._items.length;e++){if(o._items[e]._classes&&o._items[e]._classes[0]&&"colorbutton"==o._items[e]._classes[0])return o._items[e];var r=t(o._items[e]);if(r)return r}return!1}}o.on("click",function(r){if(o.theme){var l=t(o.theme.panel);if(!l)return;var n=null;for(var c in l._elmCache){n=l._elmCache[c];break}o._ptwColorPickerBookmark=o.selection.getBookmark(2,!0),jQuery(n).find(".ptwTear").css("background-color",e("forecolor"))}}),o.on("BeforeRenderUI",function(o){var e=t(o.target.theme.panel);e&&setTimeout(function(){var o=null;for(var r in e._elmCache){o=e._elmCache[r];break}jQuery(o).html('<div class="ptwTear"></div>')},10)}),jQuery(function(){o.addButton("forecolor",{type:"panelbutton",tooltip:"Text color",format:"forecolor",classes:"colorbutton",panel:{role:"application",ariaRemember:!0,html:'<div class="ptwBlInlineColorPickShell"></div>',classes:"bl-colorpanel",border:1,onpostrender:function(t){if(!t.control._ptwInited){if(t&&t.control&&t.control.parent&&t.control._parent._id){var l=jQuery("#"+t.control._parent._id+" .ptwTear"),n=jQuery.extend(g_ptwVandColorPickerOptions,{altField:l,inline:!0,color:e("forecolor"),inlineFrame:!0,select:function(e,t){var l=jQuery(":focus");r("forecolor",t.formatted),o._ptwColorPickerBookmark=o.selection.getBookmark(2,!0),l.focus()}});jQuery("#"+t.control._id+" .ptwBlInlineColorPickShell").colorpicker(n)}t.control._ptwInited=!0}},onshow:function(r){o._ptwColorPickerBookmark=o.selection.getBookmark(2,!0),jQuery("#"+r.control._id+" .ptwBlInlineColorPickShell").colorpicker("setColor",e("forecolor"))}}})})});